<!DOCTYPE html>
<html>
<head>
<title>Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
/* ===== BODY ===== */
body {
    font-family: 'Segoe UI', sans-serif;
    background: #f8f9fa;
    color: #212529;
    margin: 0;
    transition: background .3s ease, color .3s ease;
}

/* ===== TOP BAR ===== */
.topbar {
    display: flex;
    align-items: center;
    padding: 15px;
    background: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    position: sticky;
    top: 0;
    z-index: 1000;
    transition: background .3s ease;
}

.profile-btn {
    width: 42px;
    height: 42px;
    border-radius: 50%;
    background: #0d6efd;
    color: #fff;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    margin-right: 10px;
    transition: transform .2s ease, background .3s ease;
}
.profile-btn:hover {
    transform: scale(1.1);
    background: #0b5ed7;
}

.topbar h1 {
    margin: 0;
    font-size: 18px;
    color: #0d6efd;
}

/* ===== PANEL ===== */
.panel {
    position: fixed;
    top: 0;
    left: -100%;
    width: 90%;
    max-width: 420px;
    height: 100%;
    background: #ffffff;
    padding: 20px;
    overflow-y: auto;
    transition: left .35s ease, box-shadow .3s ease;
    box-shadow: 4px 0 12px rgba(0,0,0,0.2);
    z-index: 1002;
}

.panel.open {
    left: 0;
}
.profile-card {
    display: flex;
    flex-direction: column;
    padding: 18px;
    border-radius: 14px;
    background: #ffffff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    margin-bottom: 16px;
    transition: transform .25s ease, box-shadow .25s ease;
}
.profile-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

/* Header with profile picture and name */
.profile-card .card-header {
    display: flex;
    align-items: center;
    margin-bottom: 12px;
}
.profile-card .pfp {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 12px;
}
.profile-card .pfp-initials {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    background: #2563eb;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 18px;
    margin-right: 12px;
}
.profile-card h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #1e40af;
}

/* Card content */
.profile-card .card-content {
    display: grid;
    gap: 6px;
    font-size: 14px;
    color: #1f2937;
}
.profile-card .card-content div {
    background: #f3f4f6;
    padding: 8px;
    border-radius: 8px;
}

.close-btn {
    background: #dc3545;
    border: none;
    padding: 8px 12px;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    margin-bottom: 15px;
    transition: background .3s ease;
}
.close-btn:hover { background: #c82333; }

/* ===== CARDS ===== */
.card {
    background: #ffffff;
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 15px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform .25s ease, box-shadow .25s ease;
    cursor: default;
}
.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}

.card h2 {
    margin-top: 0;
    color: #0d6efd;
    font-size: 16px;
}

.info {
    display: grid;
    grid-template-columns: 1fr;
    gap: 8px;
    font-size: 14px;
}

.info div {
    background: #e9ecef;
    padding: 8px;
    border-radius: 6px;
    color: #495057;
}

/* ===== STATUS ===== */
.status {
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    font-weight: bold;
    color: #fff;
}
.verified { background: #198754; }
.pending { background: #fd7e14; }

/* ===== QR ===== */
.qr {
    text-align: center;
    margin-top: 10px;
}
.qr img {
    width: 140px;
    background: #ffffff;
    padding: 6px;
    border-radius: 8px;
}

/* ===== DASHBOARD BODY ===== */
.main {
    padding: 20px;
}

/* ===== LOGOUT BUTTON ===== */
.logout {
    margin-top: 20px;
    background: #dc3545;
    color: white;
    border: none;
    padding: 10px;
    border-radius: 8px;
    width: 100%;
    cursor: pointer;
    transition: background .3s ease, transform .2s ease;
}
.logout:hover { 
    background: #c82333;
    transform: scale(1.03);
}

/* ===== SCANNER MODAL ===== */
.scanner-modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(33,37,41,0.95);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    animation: fadeIn .3s ease forwards;
}

.scanner-modal .scanner-box {
    background: #ffffff;
    padding: 15px;
    border-radius: 12px;
    width: 90%;
    max-width: 420px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.scanner-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

#scanner {
    width: 100%;
    height: 300px;
    background: #000;
}

#scanResult {
    margin-top: 10px;
    color: #0d6efd;
    font-weight: bold;
}

/* ===== ANIMATIONS ===== */
@keyframes fadeIn {
    0% { opacity: 0; }
    100% { opacity: 1; }
}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
    <div class="profile-btn" onclick="togglePanel()">
        {{ request.user.username|slice:":1"|upper }}
    </div>
    <h1>Dashboard</h1>
</div>

<!-- MAIN CONTENT -->
<div class="main">
    <h2>Welcome, {{ request.user.username }} ðŸ‘‹</h2>
    <p>This is your dashboard workspace.</p>

    {% if request.user.role == "vendor" %}
    <div class="card">
        <h2>Vendor Verification</h2>
        <div class="status verified">âœ… Verified Vendor</div>
        <div class="qr">
            <p>Vendor QR Code</p>
            {% if request.user.vendorprofile.qr_code %}
            <img src="{{ request.user.vendorprofile.qr_code.url }}">
            {% else %}
            <p>No QR generated</p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    {% if request.user.role == "investor" %}
    <!-- Scan QR Button -->
    <button onclick="document.getElementById('scannerModal').style.display='flex'; openScanner();" class="scan-btn">ðŸ“· Scan QR</button>
    <div class="card" style="cursor:pointer;" onclick="window.location.href='/my-investments/'">
        <h2>ðŸ’° Previous Investments</h2>
        <p>Click to view all vendors you have invested in and their terms.</p>
    </div>
    {% endif %}

    {% if vendor_investments %}
    {% for inv in vendor_investments %}
    <div class="card profile-card">
        <div class="card-header">
            <!-- Profile Picture or Initials -->
            {% if inv.investor.profile_picture %}
            <img src="{{ inv.investor.profile_picture.url }}" alt="Profile" class="pfp">
            {% else %}
            <div class="pfp-initials">{{ inv.investor.username|slice:":1"|upper }}</div>
            {% endif %}
            
            <!-- Name -->
            <h3>{{ inv.investor.username }}</h3>
        </div>
        <div class="card-content">
            <div><b>Email:</b> {{ inv.investor.email }}</div>
            <div><b>Phone:</b> {{ inv.investor.phone }}</div>
            <div><b>Amount Invested:</b> â‚¹{{ inv.amount }}</div>
            <div><b>Guaranteed Return:</b> {{ inv.return_percent }}%</div>
            <div><b>Date:</b> {{ inv.date_invested|date:"d M Y" }}</div>
            <div><b>Terms:</b> {{ inv.terms }}</div>
        </div>
    </div>
    {% endfor %}
{% else %}
<p style="margin-top:10px; color:#2563eb;">No investments yet in your business.</p>
{% endif %}

</div>

<!-- PROFILE PANEL -->
<div class="panel" id="profilePanel">
    <button class="close-btn" onclick="closePanel()">Close</button>
    <div class="card">
        <h2>Account Details</h2>
        <div class="info">
            <div><b>Name</b><br>{{ request.user.username }}</div>
            <div><b>Role</b><br>{{ request.user.role|title }}</div>
            <div><b>Email</b><br>{{ request.user.email }}</div>
            <div><b>Phone</b><br>{{ request.user.phone }}</div>
        </div>
        <form action="/logout/" method="POST">
            {% csrf_token %}
            <button class="logout">Logout</button>
        </form>
    </div>
</div>

<!-- QR SCANNER MODAL -->
<div id="scannerModal" class="scanner-modal">
    <div class="scanner-box">
        <div class="scanner-header">
            <span>Scan Vendor QR</span>
            <button onclick="closeScanner()">âœ–</button>
        </div>
        <div id="scanner"></div>
        <div id="scanResult"></div>
    </div>
</div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/html5-qrcode"></script>
<script>
let qrScanner;

function togglePanel() {
    const panel = document.getElementById("profilePanel");
    panel.classList.toggle("open");
}

function closePanel() {
    const panel = document.getElementById("profilePanel");
    panel.classList.remove("open");
}

function openScanner() {
    const scannerDiv = document.getElementById("scanner");
    const resultBox = document.getElementById("scanResult");
    scannerDiv.innerHTML = "";
    resultBox.style.display = "none";
    resultBox.innerHTML = "";
    qrScanner = new Html5Qrcode("scanner");
    const config = { fps: 10, qrbox: 350, experimentalFeatures: { useBarCodeDetectorIfSupported: true } };
    qrScanner.start({ facingMode: { exact: "environment" } }, config,
        (decodedText) => {
            resultBox.style.display = "block";
            resultBox.innerHTML = "âœ… Scanned:<br>" + decodedText;
            const match = decodedText.match(/ID:([0-9a-fA-F-]+)/);
            if(match){ window.location.href = `/vendor/verify/${match[1]}/`; } 
            else { alert("Invalid QR code format. Cannot find vendor ID."); }
            qrScanner.stop().catch(err => console.error(err));
        },
        (errorMessage) => { console.log(errorMessage); }
    ).catch(err => { alert("Camera access denied or not available on this device."); console.error(err); });
}

function closeScanner() {
    if(qrScanner){ qrScanner.stop().catch(err => console.error(err)); }
    document.getElementById("scannerModal").style.display = "none";
}
</script>

</body>
</html>
